<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0b1220">
  <title>Courses</title>
  <link rel="manifest" href="manifest.json">

  <style>
    :root{
      --bg:#0b1220;
      --card:#101a33;
      --text:#e9eefc;
      --muted:#a8b3d6;
      --line:rgba(255,255,255,.10);
      --accent:#6ea8fe;
      --accent2:#7c5cff;
      --ok:#3ddc97;
      --danger:#ff5a7a;
      --warn:#ffd166;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background: radial-gradient(1200px 700px at 20% -10%, rgba(110,168,254,.25), transparent 55%),
                  radial-gradient(900px 600px at 110% 30%, rgba(124,92,255,.20), transparent 60%),
                  var(--bg);
      min-height:100vh;
    }
    .safe{
      padding: max(18px, env(safe-area-inset-top)) 16px max(18px, env(safe-area-inset-bottom));
      max-width: 720px;
      margin: 0 auto;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: var(--shadow);
    }
    h1{ font-size:18px; margin:0; letter-spacing:.2px; line-height:1.2; }
    .subtitle{ margin:2px 0 0; color:var(--muted); font-size:13px; }
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      background: rgba(255,255,255,.04);
      backdrop-filter: blur(8px);
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    input[type="file"]{
      width:100%;
      padding: 12px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.22);
      background: rgba(15,23,48,.45);
      color: var(--muted);
    }
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .btn{
      flex:1;
      min-width: 160px;
      border:0;
      border-radius: 16px;
      padding: 14px 14px;
      font-size: 15px;
      font-weight: 650;
      cursor:pointer;
      transition: transform .06s ease, opacity .15s ease;
    }
    .btn:active{ transform: scale(.99); }
    .btn.primary{
      color:#0b1220;
      background: linear-gradient(135deg, var(--accent), #93c5fd);
    }
    .btn.secondary{
      color: var(--text);
      background: rgba(255,255,255,.07);
      border:1px solid var(--line);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .status{
      font-size: 13px;
      color: var(--muted);
      display:flex; gap:10px; align-items:center;
      margin-top: 10px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.22);
    }
    .dot.ok{ background: var(--ok); }
    .dot.err{ background: var(--danger); }
    .dot.wait{ background: var(--warn); }

    .preview{
      display:none;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(15,23,48,.35);
      margin-top:12px;
    }
    .preview img{ width:100%; display:block; }

    .sectionTitle{
      margin: 16px 2px 10px;
      font-size: 14px;
      color: var(--muted);
      letter-spacing:.2px;
    }
    .deals{ display:flex; flex-direction:column; gap:10px; }
    .deal{
      background: rgba(15,23,48,.40);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      flex-direction: column;
      gap:10px;
    }
    .dealHeader{
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .dealTitle{
      margin:0;
      font-weight: 800;
      font-size: 15px;
      line-height: 1.25;
      word-break: break-word;
    }
    .dealMeta{
      margin-top:6px;
      color: var(--muted);
      font-size: 12.5px;
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color: var(--text);
      font-size: 12px;
      white-space: nowrap;
    }
    .count{
      font-weight: 800;
      font-size: 13px;
      white-space: nowrap;
      align-self: flex-start;
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(110,168,254,.16);
      border: 1px solid rgba(110,168,254,.35);
    }
    .promoLine{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding:10px;
      font-size: 13px;
      color: rgba(233,238,252,.9);
      white-space: pre-wrap;
      line-height: 1.25;
    }
    .hint{
      margin-top:10px;
      font-size: 12.5px;
      color: rgba(233,238,252,.75);
      line-height: 1.35;
    }
    a{ color:#bcd6ff; text-decoration:none; }
    a:hover{ text-decoration:underline; }
  </style>
</head>

<body>
  <div class="safe">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Courses</h1>
          <div class="subtitle">Photo ‚Üí meilleurs magasins ‚Üí promos</div>
        </div>
      </div>
      <div class="pill">PWA</div>
    </div>

    <div class="card">
      <input id="file" type="file" accept="image/*" capture="environment" />

      <div id="preview" class="preview">
        <img id="img" alt="Aper√ßu" />
      </div>

      <div class="btnRow">
        <button id="btn" class="btn primary" onclick="sendPhoto()">üì∏ Analyser la photo</button>
        <button class="btn secondary" onclick="resetAll()">‚Ü©Ô∏é R√©initialiser</button>
      </div>

      <div id="status" class="status">
        <span class="dot"></span>
        <span>Choisis une photo pour commencer.</span>
      </div>

      <div class="hint">
        Astuce : sur iPhone/Android ‚Üí menu du navigateur ‚Üí ‚ÄúAjouter √† l‚Äô√©cran d‚Äôaccueil‚Äù.
      </div>
    </div>

    <div class="sectionTitle">R√©sultats</div>
    <div id="result" class="deals"></div>
  </div>

<script>
  // ‚úÖ Ton webhook n8n (Production)
  const WEBHOOK_URL = "https://actual.app.n8n.cloud/webhook/2a4af03d-393e-483e-acf8-6aede052f05a";

  // ‚ö†Ô∏è Si tu as une erreur CORS, on utilisera un proxy Cloudflare gratuit (je te le donne plus bas)
  // const WEBHOOK_URL = "https://TON-PROXY.workers.dev/?to=" + encodeURIComponent("https://actual.app.n8n.cloud/webhook/2a4af03d-393e-483e-acf8-6aede052f05a");

  const fileInput = document.getElementById('file');
  const preview = document.getElementById('preview');
  const img = document.getElementById('img');
  const statusEl = document.getElementById('status');
  const resultEl = document.getElementById('result');
  const btn = document.getElementById('btn');

  function setStatus(state, text){
    const dot = statusEl.querySelector('.dot');
    dot.className = 'dot' + (state ? ' ' + state : '');
    statusEl.querySelector('span:last-child').textContent = text;
  }

  fileInput.addEventListener('change', () => {
    const f = fileInput.files?.[0];
    if (!f) return;
    img.src = URL.createObjectURL(f);
    preview.style.display = 'block';
    resultEl.innerHTML = "";
    setStatus('ok', 'Photo pr√™te. Lance l‚Äôanalyse.');
  });

  async function sendPhoto() {
    const f = fileInput.files?.[0];
    if (!f) { setStatus('err', 'Choisis une photo d‚Äôabord.'); return; }

    btn.disabled = true;
    setStatus('wait', 'Analyse en cours‚Ä¶');
    resultEl.innerHTML = "";

    try {
      const form = new FormData();
      // champ "photo" : on ajustera si ton Webhook attend un autre nom
      form.append("photo", f, f.name);

      const res = await fetch(WEBHOOK_URL, { method: "POST", body: form });
      if (!res.ok) throw new Error("Erreur n8n: " + res.status);

      const data = await res.json();

      // Attendu: [{ enseigne, badge, score, promos:[...] }, ...]
      if (!Array.isArray(data) || data.length === 0) {
        setStatus('ok', 'Termin√©, mais aucun r√©sultat.');
        return;
      }

      setStatus('ok', 'Termin√© ‚úÖ');

      resultEl.innerHTML = data.map(store => {
        const enseigne = esc(store.enseigne ?? "MAGASIN");
        const badge = esc(store.badge ?? "üè™");
        const score = esc(String(store.score ?? ""));
        const promos = Array.isArray(store.promos) ? store.promos : [];

        return `
          <div class="deal">
            <div class="dealHeader">
              <div>
                <p class="dealTitle">${badge} ${enseigne}</p>
                <div class="dealMeta">
                  <span class="tag">Promos d√©tect√©es</span>
                </div>
              </div>
              <div class="count">${score} promos</div>
            </div>

            ${promos.map(p => `<div class="promoLine">${esc(p)}</div>`).join("")}
          </div>
        `;
      }).join("");

    } catch (e) {
      setStatus('err', String(e.message || e));
      resultEl.innerHTML = `
        <div class="deal">
          <p class="dealTitle">‚ùå Erreur</p>
          <div class="promoLine">${esc(String(e.message || e))}</div>
          <div class="hint">Si tu vois ‚ÄúCORS‚Äù, on active le proxy gratuit Cloudflare.</div>
        </div>
      `;
    } finally {
      btn.disabled = false;
    }
  }

  function resetAll() {
    fileInput.value = "";
    preview.style.display = "none";
    img.src = "";
    resultEl.innerHTML = "";
    setStatus('', 'Choisis une photo pour commencer.');
  }

  function esc(s){
    return String(s).replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }
</script>
</body>
</html>
